{"version":3,"file":"sequelize.js","sources":["../../../src/lib/sequelize.ts"],"sourcesContent":["import { Condition } from '@ucast/core';\nimport { ModelType, Utils, literal } from 'sequelize';\nimport {\n  createSqlInterpreter,\n  allInterpreters,\n  SqlOperator,\n  createDialects,\n  mysql\n} from '../index';\n\nfunction joinRelation(relationName: string, Model: ModelType) {\n  return Model.associations.hasOwnProperty(relationName);\n}\n\nconst dialects = createDialects({\n  joinRelation,\n  paramPlaceholder: mysql.paramPlaceholder,\n});\n\nexport function createInterpreter(interpreters: Record<string, SqlOperator<any>>) {\n  const interpretSQL = createSqlInterpreter(interpreters);\n\n  return (condition: Condition, Model: ModelType) => {\n    const dialect = Model.sequelize!.getDialect() as keyof typeof dialects;\n    const options = dialects[dialect];\n\n    if (!options) {\n      throw new Error(`Unsupported database dialect: ${dialect}`);\n    }\n\n    const [sql, params, joins] = interpretSQL(condition, options, Model);\n    return {\n      include: joins.map(association => ({ association, required: true })),\n      where: literal(Utils.format([sql, ...(params as string[])], dialect)),\n    };\n  };\n}\n\nexport const interpret = createInterpreter(allInterpreters);\n"],"names":["joinRelation","relationName","Model","associations","hasOwnProperty","dialects","createDialects","paramPlaceholder","mysql","createInterpreter","interpreters","interpretSQL","createSqlInterpreter","condition","dialect","sequelize","getDialect","options","Error","sql","params","joins","include","map","association","required","where","literal","Utils","format","interpret","allInterpreters"],"mappings":";;;AAUA,SAASA,YAAT,CAAsBC,YAAtB,EAA4CC,KAA5C,EAA8D;AAC5D,SAAOA,KAAK,CAACC,YAAN,CAAmBC,cAAnB,CAAkCH,YAAlC,CAAP;AACD;;AAED,MAAMI,QAAQ,GAAGC,cAAc,CAAC;AAC9BN,EAAAA,YAD8B;AAE9BO,EAAAA,gBAAgB,EAAEC,KAAK,CAACD;AAFM,CAAD,CAA/B;AAKO,SAASE,iBAAT,CAA2BC,YAA3B,EAA2E;AAChF,QAAMC,YAAY,GAAGC,oBAAoB,CAACF,YAAD,CAAzC;AAEA,SAAO,CAACG,SAAD,EAAuBX,KAAvB,KAA4C;AACjD,UAAMY,OAAO,GAAGZ,KAAK,CAACa,SAAN,CAAiBC,UAAjB,EAAhB;AACA,UAAMC,OAAO,GAAGZ,QAAQ,CAACS,OAAD,CAAxB;;AAEA,QAAI,CAACG,OAAL,EAAc;AACZ,YAAM,IAAIC,KAAJ,CAAW,iCAAgCJ,OAAQ,EAAnD,CAAN;AACD;;AAED,UAAM,CAACK,GAAD,EAAMC,MAAN,EAAcC,KAAd,IAAuBV,YAAY,CAACE,SAAD,EAAYI,OAAZ,EAAqBf,KAArB,CAAzC;AACA,WAAO;AACLoB,MAAAA,OAAO,EAAED,KAAK,CAACE,GAAN,CAAUC,WAAW,KAAK;AAAEA,QAAAA,WAAF;AAAeC,QAAAA,QAAQ,EAAE;AAAzB,OAAL,CAArB,CADJ;AAELC,MAAAA,KAAK,EAAEC,OAAO,CAACC,KAAK,CAACC,MAAN,CAAa,CAACV,GAAD,EAAM,GAAIC,MAAV,CAAb,EAA6CN,OAA7C,CAAD;AAFT,KAAP;AAID,GAbD;AAcD;MAEYgB,SAAS,GAAGrB,iBAAiB,CAACsB,eAAD;;;;"}